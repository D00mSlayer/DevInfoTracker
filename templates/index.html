[% extends "base.html" %]

[% block content %]
<div ng-app="productApp" ng-controller="ProductController">
    <!-- Search Section -->
    <div class="container mb-4">
        <div class="row">
            <div class="col-md-6">
                <h1 class="mb-4">
                    <i class="fas fa-sitemap me-2"></i>
                    Product Environment Manager
                </h1>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search products, environments, services..." 
                           ng-model="searchQuery" ng-change="search()">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="container mb-4" ng-if="searchResults.length > 0">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>
                    Search Results
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <div class="list-group-item d-flex justify-content-between align-items-start" 
                         ng-repeat="result in searchResults">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-{{getIcon(result.type)}} me-2"></i>
                                {{result.name}}
                            </h6>
                            <small class="text-muted">{{result.path.join(' â†’ ')}}</small>
                        </div>
                        <span class="badge bg-secondary">{{result.type}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Hierarchy -->
    <div class="container">
        <div class="accordion" id="productsAccordion">
            <div class="accordion-item mb-3" ng-repeat="product in products">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#product-{{$index}}">
                        <i class="fas fa-cube me-2"></i>
                        <strong>{{product.name}}</strong>
                        <span class="ms-2 text-muted">{{product.description}}</span>
                    </button>
                </h2>
                <div id="product-{{$index}}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                        <!-- Base Products -->
                        <div class="accordion" id="basesAccordion-{{$index}}">
                            <div class="accordion-item mb-2" ng-repeat="base in product.bases">
                                <h3 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#base-{{$parent.$index}}-{{$index}}">
                                        <i class="fas fa-layer-group me-2"></i>
                                        {{base.name}}
                                        <span class="ms-2 text-muted">{{base.description}}</span>
                                    </button>
                                </h3>
                                <div id="base-{{$parent.$index}}-{{$index}}" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <!-- Versions -->
                                        <div class="accordion" id="versionsAccordion-{{$parent.$index}}-{{$index}}">
                                            <div class="accordion-item mb-2" ng-repeat="version in base.versions">
                                                <h4 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button"
                                                            data-bs-toggle="collapse" data-bs-target="#version-{{$parent.$parent.$index}}-{{$parent.$index}}-{{$index}}">
                                                        <i class="fas fa-code-branch me-2"></i>
                                                        {{version.name}}
                                                        <span class="ms-2 text-muted">{{version.description}}</span>
                                                    </button>
                                                </h4>
                                                <div id="version-{{$parent.$parent.$index}}-{{$parent.$index}}-{{$index}}" class="accordion-collapse collapse">
                                                    <div class="accordion-body">
                                                        <!-- Environments -->
                                                        <div class="row g-3">
                                                            <div class="col-md-6 col-lg-4" ng-repeat="env in version.environments">
                                                                <div class="card h-100">
                                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                                        <h5 class="mb-0">
                                                                            <i class="fas fa-server me-2"></i>
                                                                            {{env.name}}
                                                                        </h5>
                                                                        <span class="badge bg-success">Online</span>
                                                                    </div>
                                                                    <div class="card-body">
                                                                        <!-- Site URL -->
                                                                        <div class="mb-3">
                                                                            <strong>Site URL:</strong><br>
                                                                            <a href="{{env.site_url}}" target="_blank" class="text-decoration-none">
                                                                                <i class="fas fa-external-link-alt me-1"></i>
                                                                                {{env.site_url}}
                                                                            </a>
                                                                        </div>

                                                                        <!-- Git Build -->
                                                                        <div class="mb-3">
                                                                            <strong>Git Build:</strong><br>
                                                                            <a href="{{env.git_build_url}}" target="_blank" class="text-decoration-none">
                                                                                <i class="fas fa-{{env.git_type === 'branch' ? 'code-branch' : 'tag'}} me-1"></i>
                                                                                {{env.git_type === 'branch' ? 'Branch' : 'Tag'}}
                                                                            </a>
                                                                        </div>

                                                                        <!-- Databases -->
                                                                        <div class="mb-3" ng-if="env.databases && env.databases.length > 0">
                                                                            <strong>Databases:</strong>
                                                                            <div class="mt-2">
                                                                                <div class="mb-2" ng-repeat="db in env.databases">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <span>
                                                                                            <i class="fas fa-database me-1"></i>
                                                                                            {{db.name}}
                                                                                        </span>
                                                                                        <span class="badge bg-{{db.status === 'online' ? 'success' : 'danger'}}">
                                                                                            {{db.status}}
                                                                                        </span>
                                                                                    </div>
                                                                                    <small class="text-muted">
                                                                                        {{db.server}}:{{db.port}}/{{db.database}}
                                                                                    </small>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <!-- Microservices -->
                                                                        <div ng-if="env.microservices && env.microservices.length > 0">
                                                                            <strong>Microservices:</strong>
                                                                            <div class="mt-2">
                                                                                <div class="mb-2" ng-repeat="service in env.microservices">
                                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                                        <span>
                                                                                            <i class="fas fa-cogs me-1"></i>
                                                                                            {{service.name}}
                                                                                        </span>
                                                                                        <span class="badge bg-{{service.status === 'online' ? 'success' : 'danger'}}">
                                                                                            {{service.status}}
                                                                                        </span>
                                                                                    </div>
                                                                                    <small class="text-muted d-block">
                                                                                        <a href="{{service.server_url}}" target="_blank" class="text-decoration-none">
                                                                                            {{service.server_url}}:{{service.port}}
                                                                                        </a>
                                                                                    </small>
                                                                                    <small class="text-muted">
                                                                                        <a href="{{service.git_build_url}}" target="_blank" class="text-decoration-none">
                                                                                            <i class="fas fa-{{service.git_type === 'branch' ? 'code-branch' : 'tag'}} me-1"></i>
                                                                                            {{service.git_type === 'branch' ? 'Branch' : 'Tag'}}
                                                                                        </a>
                                                                                    </small>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <!-- Configuration Section -->
                                                                        <div class="mt-3">
                                                                            <button class="btn btn-outline-info btn-sm" ng-click="searchConfigurations(env)">
                                                                                <i class="fas fa-search me-1"></i>
                                                                                Search Configurations
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading state -->
    <div class="container text-center" ng-if="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading product data...</p>
    </div>

    <!-- Empty state -->
    <div class="container text-center" ng-if="!loading && products.length === 0">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No products found. Please check your data.yaml file.
        </div>
    </div>
</div>
[% endblock %]

[% block scripts %]
<script>
    // Pass data from Flask to AngularJS
    window.productData = [[ data | tojson ]];
</script>
[% endblock %]